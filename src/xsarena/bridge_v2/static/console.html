<!DOCTYPE html>
<html>
<head>
    <title>XSArena Mission Control</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; text-align: center; }
        .jobs-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .jobs-table th, .jobs-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .jobs-table th { background-color: #4CAF50; color: white; }
        .status-running { color: #4CAF50; font-weight: bold; }
        .status-pending { color: #FF9800; font-weight: bold; }
        .status-done { color: #2196F3; font-weight: bold; }
        .status-failed { color: #f44336; font-weight: bold; }
        .status-cancelled { color: #9E9E9E; font-weight: bold; }
        .refresh-btn { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-bottom: 20px; }
        .refresh-btn:hover { background-color: #45a049; }
        .job-details { margin-top: 20px; }
        .event-log {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            font-family: monospace;
            white-space: pre-wrap;
        }
        select { padding: 8px; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>XSArena Mission Control</h1>
        <button class="refresh-btn" onclick="refreshJobs()">Refresh Jobs</button>
        <select id="jobSelect" onchange="loadJobLog()">
            <option value="">Select a job to view log...</option>
        </select>

        <table class="jobs-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>State</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Chunks</th>
                    <th>Retries</th>
                    <th>Backend</th>
                </tr>
            </thead>
            <tbody id="jobsTableBody">
                <!-- Jobs will be populated here -->
            </tbody>
        </table>

        <div class="job-details">
            <h3>Event Log</h3>
            <div id="eventLog" class="event-log">Select a job to view its event log...</div>
        </div>
    </div>

    <script>
        let jobs = [];
        let ws = null;
        let selectedJobId = null;

        // Load jobs initially and set up auto-refresh
        document.addEventListener('DOMContentLoaded', function() {
            refreshJobs();
            setInterval(refreshJobs, 5000); // Refresh every 5 seconds
        });

        function refreshJobs() {
            fetch('/api/jobs')
                .then(response => response.json())
                .then(data => {
                    jobs = data.jobs;
                    updateJobsTable();
                    updateJobSelect();
                })
                .catch(error => console.error('Error fetching jobs:', error));
        }

        function updateJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';

            jobs.forEach(job => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = job.id.substring(0, 8) + '...';
                row.insertCell(1).textContent = job.name;

                const stateCell = row.insertCell(2);
                stateCell.className = `status-${job.state.toLowerCase()}`;
                stateCell.textContent = job.state;

                row.insertCell(3).textContent = new Date(job.created_at).toLocaleString();
                row.insertCell(4).textContent = new Date(job.updated_at).toLocaleString();
                row.insertCell(5).textContent = job.chunks;
                row.insertCell(6).textContent = job.retries;
                row.insertCell(7).textContent = job.backend;
            });
        }

        function updateJobSelect() {
            const select = document.getElementById('jobSelect');
            // Keep the current selection if it still exists
            const currentSelection = select.value;

            // Clear options except the first one
            select.innerHTML = '<option value="">Select a job to view log...</option>';

            jobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                option.textContent = `${job.id.substring(0, 8)}... - ${job.name} (${job.state})`;
                select.appendChild(option);
            });

            // Restore selection if the job still exists
            if (currentSelection) {
                const jobExists = jobs.some(job => job.id === currentSelection);
                if (jobExists) {
                    select.value = currentSelection;
                    selectedJobId = currentSelection;
                    loadJobLog();
                } else {
                    select.value = '';
                    selectedJobId = null;
                    document.getElementById('eventLog').textContent = 'Select a job to view its event log...';
                }
            }
        }

        function loadJobLog() {
            const jobId = document.getElementById('jobSelect').value;
            selectedJobId = jobId;

            if (!jobId) {
                document.getElementById('eventLog').textContent = 'Select a job to view its event log...';
                return;
            }

            // Load initial events from the job's events file
            fetch(`/api/jobs/${jobId}`)
                .then(response => response.json())
                .then(job => {
                    document.getElementById('eventLog').textContent = `Job: ${job.name}\nState: ${job.state}\nChunks: ${job.chunks}\nRetries: ${job.retries}`;

                    // Now poll the events file for updates
                    if (selectedJobId) {
                        pollJobEvents(selectedJobId);
                    }
                })
                .catch(error => console.error('Error fetching job details:', error));
        }

        function pollJobEvents(jobId) {
            // For now, just poll the job API endpoint to get updated info
            // In a real implementation, we'd have a dedicated event stream endpoint
            if (selectedJobId !== jobId) return; // Stop if user selected a different job

            fetch(`/api/jobs/${jobId}`)
                .then(response => response.json())
                .then(job => {
                    document.getElementById('eventLog').textContent = `Job: ${job.name}\nState: ${job.state}\nChunks: ${job.chunks}\nRetries: ${job.retries}\nUpdated: ${new Date(job.updated_at).toLocaleString()}`;
                })
                .catch(error => console.error('Error fetching job events:', error));

            // Continue polling every 2 seconds
            setTimeout(() => pollJobEvents(jobId), 2000);
        }
    </script>
</body>
</html>
